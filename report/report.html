<!DOCTYPE html>
<html lang="en">
<head>
  <title>CPUT Report Page</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="../home/homestyle.css">
</head>

<body>

  <header>
    <div class="logo">
  <img src="../img/CPUTLogo.jpg" alt="CPUT Logo" class="logo-img" />
    </div>
    <h1 class="header-title">CPUT Marketplace and Exchange</h1>
    <div class="header-icons">
  <img src="../img/messenger_2111573.png" alt="Message" class="header-icon" id="messengerIcon">
  <img src="../img/time_16601413.png" alt="Notifications" class="header-icon">
  <img src="../img/user_9190837.png" alt="User" class="header-icon">
    </div>
  </header>
  <div class="main-container">
    <aside class="sidebar" aria-label="Sidebar navigation">
      <div class="search-container">
        <input type="search" id="sidebarSearchInput" class="search-input" placeholder="Search products by name..." style="flex:1;" />
        <button id="sidebarSearchButton" class="menu-item" style="margin-left:10px;">Search</button>
      </div>
      <button class="menu-item" onclick="globalThis.location.href='../home/home.html'">Back to Home</button>
      <button class="menu-item" onclick="globalThis.location.href='../chat/chat.html'">Chat</button>
      <button class="menu-item" onclick="globalThis.location.href='../search/search.html'">Search</button>
    </aside>
    <main class="content-area">
      <h2 class="section-title">Report an Issue</h2>
      <div class="featured-product" style="box-shadow:none; margin-bottom:20px;max-width:500px;">
        <form id="reportForm" style="width:100%;max-width:400px;margin:0 auto;">
          <input type="text" placeholder="First Name" id="firstName" style="margin-bottom:12px;" />
          <input type="text" placeholder="Last Name" id="lastName" style="margin-bottom:12px;" />
          <input type="text" placeholder="Report Date" id="reportDate" style="margin-bottom:12px;" />
          <input type="text" placeholder="Subject (e.g. username)" id="subject" style="margin-bottom:12px;" />
          <textarea placeholder="Please enter what the issue was" id="message" maxlength="300"></textarea>
          <div style="margin:6px 0;color:#888;font-size:0.95rem;">
            <span class="char-count" id="charCount">0 / 300</span>
          </div>
          <button class="menu-item submit-btn" type="submit" style="width:100%;margin-top:8px;">SUBMIT</button>
        </form>
        <div class="thank-you" style="display:none;">Thank you for your submission!</div>
      </div>
    </main>
  </div>
  <footer>
    <div class="copyright">© CPUT Marketplace. All rights reserved.</div>
  </footer>
  <script>
    document.getElementById('messengerIcon').onclick = function() {
      globalThis.location.href = '../chat/chat.html';
    };
    
    document.querySelector('img[alt="Notifications"]').onclick = function() {
      globalThis.location.href = '../notifications.html';
    };
    
    document.querySelector('img[alt="User"]').onclick = function() {
      globalThis.location.href = '../login/login.html';
    };
    // Autofill subject if ?user= is present in query string
    const params = new URLSearchParams(globalThis.location.search);
    const reportedUser = params.get('user');
    const subjectInput = document.getElementById("subject");
    if (reportedUser) {
      subjectInput.value = reportedUser;
    }
    const firstNameInput = document.getElementById("firstName");
    const lastNameInput = document.getElementById("lastName");
    const reportDateInput = document.getElementById("reportDate");
    const messageTextarea = document.getElementById("message");
    const reportForm = document.getElementById("reportForm");
    const thankYouMessage = document.querySelector(".thank-you");
    const charCount = document.getElementById("charCount");

    // Live character count
    messageTextarea.addEventListener("input", () => {
      charCount.textContent = `${messageTextarea.value.length} / 300`;
    });

    reportForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const firstName = firstNameInput.value.trim();
      const lastName = lastNameInput.value.trim();
      const reportDate = reportDateInput.value.trim();
      const subject = subjectInput.value.trim();
      const message = messageTextarea.value.trim();

      if (!firstName || !lastName || !reportDate || !subject || !message) {
        alert("❗ Please fill in all fields.");
        thankYouMessage.style.display = "none";
        return;
      }

      // Submit to backend
      const API_BASE = globalThis.__API_BASE__ || '';
      await fetch(API_BASE + '/api/report', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ firstName, lastName, reportDate, subject, message })
      });

      // Show thank you message
      thankYouMessage.style.display = "block";
      reportForm.querySelector('.submit-btn').disabled = true;
      setTimeout(() => {
        firstNameInput.value = "";
        lastNameInput.value = "";
        reportDateInput.value = "";
        subjectInput.value = "";
        messageTextarea.value = "";
        charCount.textContent = "0 / 300";
        thankYouMessage.style.display = "none";
        reportForm.querySelector('.submit-btn').disabled = false;
      }, 4000);
    });
  </script>
</body>
</html>
